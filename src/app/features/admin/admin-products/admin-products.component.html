<app-header></app-header>

<div class="admin-page" [class.dark-theme]="isDark" [class.light-theme]="!isDark">

  <div class="header-title-row">
    <h1>Inventory Dashboard üì¶</h1>
    <button class="btn-create" (click)="openCreate()">
      <span>+</span> New Product
    </button>
  </div>

  <nav class="admin-nav">
    <a routerLink="/admin" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">Dashboard</a>
    <a routerLink="/admin/products" routerLinkActive="active">Products</a>
  </nav>

  <div class="search-filter-bar">
    <div class="search-box">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      <input
        type="text"
        placeholder="Search by name, SKU..."
        [value]="searchTerm"
        (input)="onSearchChange($event)">
    </div>

    <div class="filter-group">
      <select (change)="onCategoryFilter($event)">
        <option value="">All Sets</option>
        <option *ngFor="let c of categories" [value]="c.id">{{ c.name }}</option>
      </select>

      <select (change)="onTypeFilter($event)">
        <option value="">All Types</option>
        <option *ngFor="let t of productTypes" [value]="t.value">{{ t.label }}</option>
      </select>

      <select (change)="onStatusFilter($event)">
        <option value="">All Status</option>
        <option value="active">Active Only</option>
        <option value="inactive">Inactive Only</option>
        <option value="inStock">In Stock</option>
        <option value="outOfStock">Out of Stock</option>
      </select>
    </div>
  </div>

  <div class="results-count">
    {{ filteredProducts.length }} product{{ filteredProducts.length !== 1 ? 's' : '' }}
  </div>

  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
  </div>

  <div class="table-container" *ngIf="!loading">
    <table class="admin-table">
      <thead>
      <tr>
        <th width="80">Visual</th>
        <th>Product Info</th>
        <th>Category</th>
        <th>Type</th>
        <th>Price</th>
        <th>Stock</th>
        <th>Status</th>
        <th width="120">Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let p of paginatedProducts" (click)="openEdit(p)">
        <td>
          <img [src]="p.image" alt="product" class="table-thumb">
        </td>
        <td>
          <div class="name-cell">
            <span>
                {{ p.name }}
              <div class="featured-badge" *ngIf="p.featured">Featured</div>
            </span>
            <div class="sku-text">{{ p.sku }}</div>
          </div>
        </td>
        <td>{{ p.categoryName || '‚Äî' }}</td>
        <td><span class="type-badge">{{ p.type.replace('_', ' ') }}</span></td>
        <td style="font-weight: 700; color: #ef4444;">{{ p.price | currency }}</td>
        <td>
           <span class="badge" [ngStyle]="{
             'background': p.inStock ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)',
             'color': p.inStock ? '#22c55e' : '#f87171',
             'border': '1px solid ' + (p.inStock ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'),
             'padding': '4px 8px', 'border-radius': '6px', 'font-size': '0.75rem'
           }">
             {{ p.inStock ? 'In Stock' : 'Out of Stock' }}
           </span>
        </td>
        <td>
          <span class="status-dot" [class.active]="p.active" [title]="p.active ? 'Visible' : 'Hidden'"></span>
        </td>
        <td (click)="$event.stopPropagation()">
          <div class="actions-wrapper">
            <button class="btn-icon" (click)="openEdit(p)" title="Edit">
              ‚úèÔ∏è
            </button>
            <button class="btn-icon delete" (click)="onDelete(p)" title="Delete">
              üóëÔ∏è
            </button>
          </div>
        </td>
      </tr>
      <tr *ngIf="paginatedProducts.length === 0">
        <td colspan="8" style="text-align: center; padding: 4rem; opacity: 0.6;">
          <div style="font-size: 2rem; margin-bottom: 1rem;">üîç</div>
          No products found matching your filters.
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <div class="pagination" *ngIf="!loading && totalPages > 1">
    <button class="page-btn" (click)="previousPage()" [disabled]="currentPage === 0">‚Äπ</button>
    <button
      *ngFor="let page of [].constructor(totalPages); let i = index"
      class="page-btn"
      [class.active]="i === currentPage"
      (click)="goToPage(i)">
      {{ i + 1 }}
    </button>
    <button class="page-btn" (click)="nextPage()" [disabled]="currentPage === totalPages - 1">‚Ä∫</button>
  </div>

  <div class="modal-overlay" *ngIf="showForm" (click)="closeForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>{{ isEditing ? 'Edit Product' : 'Add New Product' }}</h2>

      <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
        <div class="row">
          <div class="form-group half">
            <label>SKU</label>
            <input type="text" formControlName="sku" [readonly]="isEditing" placeholder="SV03-001">
          </div>
          <div class="form-group half">
            <label>Name</label>
            <input type="text" formControlName="name" placeholder="Charizard ex">
          </div>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea formControlName="description" rows="3" placeholder="Description of the product..."></textarea>
        </div>

        <div class="row">
          <div class="form-group half">
            <label>Price ($)</label>
            <input type="number" formControlName="price" step="0.01" placeholder="0.00">
          </div>
          <div class="form-group half" *ngIf="!isEditing">
            <label>Initial Stock</label>
            <input type="number" formControlName="initialStock" min="0" placeholder="0">
          </div>
          <div class="form-group half">
            <label>Type</label>
            <select formControlName="type">
              <option *ngFor="let t of productTypes" [value]="t.value">{{ t.label }}</option>
            </select>
          </div>
        </div>

        <div class="nested-form-section" formGroupName="cardDetails" *ngIf="productForm.get('type')?.value === 'SINGLE'">
          <h3 class="section-title">Single Card Data</h3>

          <div class="row">
            <div class="form-group half">
              <label>HP</label>
              <input type="text" formControlName="hp" placeholder="330">
            </div>
            <div class="form-group half">
              <label>Types</label>
              <input type="text" formControlName="types" placeholder="Fire">
            </div>
          </div>

          <div class="row">
            <div class="form-group half">
              <label>Stage</label>
              <input type="text" formControlName="stage" placeholder="Stage 2">
            </div>
            <div class="form-group half">
              <label>Weakness</label>
              <input type="text" formControlName="weakness" placeholder="Water x2">
            </div>
          </div>

          <div class="row">
            <div class="form-group half">
              <label>Retreat Cost</label>
              <input type="text" formControlName="retreatCost" placeholder="2">
            </div>
            <div class="form-group half">
              <label>Resistance</label>
              <input type="text" formControlName="resistance" placeholder="Grass -30">
            </div>
          </div>

          <div class="form-group">
            <label>Attacks & Abilities</label>
            <textarea formControlName="attackDetails" rows="3" placeholder="[RC] Wing Attack (60)"></textarea>
          </div>

          <div class="form-group">
            <label>Flavor Text</label>
            <textarea formControlName="flavorText" rows="2" placeholder="Pokedex entry..."></textarea>
          </div>
        </div>

        <div class="row">
          <div class="form-group half">
            <label>Artist / Illustrator</label>
            <input type="text" formControlName="illustrator" placeholder="e.g. Mitsuhiro Arita">
          </div>
        </div>

        <div class="form-group">
          <label>Category (Set)</label>
          <select formControlName="categoryId">
            <option value="" disabled>Select a Set...</option>
            <option *ngFor="let c of categories" [value]="c.id">{{ c.name }} ({{ c.code || 'N/A' }})</option>
          </select>
        </div>

        <div class="form-group">
          <label>Image URL</label>
          <input type="text" formControlName="image" placeholder="https://...">
        </div>

        <div class="row">
          <div class="form-group half">
            <label>Rarity</label>
            <select formControlName="rarity">
              <option [ngValue]="null">Select Rarity...</option>
              <option *ngFor="let r of rarities" [value]="r.value">{{ r.label }}</option>
            </select>
          </div>
          <div class="form-group half">
            <label>Condition</label>
            <select formControlName="condition">
              <option [ngValue]="null">Select Condition...</option>
              <option *ngFor="let c of conditions" [value]="c.value">{{ c.label }}</option>
            </select>
          </div>
        </div>

        <div class="nested-form-section" *ngIf="isEditing" style="border-color: rgba(74, 222, 128, 0.3); background: rgba(74, 222, 128, 0.05);">
          <h3 class="section-title" style="color: #4ade80;">
            üì¶ Quick Restock
          </h3>

          <div class="row" style="align-items: flex-end;">
            <div class="form-group" style="flex: 2;">
              <label>Add Quantity to Inventory</label>
              <input type="number" #restockInput placeholder="Ex: 10" min="1" style="border-color: rgba(74, 222, 128, 0.5);">
            </div>

            <div class="form-group" style="flex: 1;">
              <button type="button"
                      class="btn-submit"
                      style="background-color: #4ade80; width: 100%; border: none; font-weight: bold; color: #000;"
                      (click)="onRestock(restockInput)">
                + Add Stock
              </button>
            </div>
          </div>

          <p style="font-size: 0.8rem; color: #a1a1aa; margin-top: 5px; font-style: italic;">
            This will instantly update the inventory and generate a movement log.
          </p>
        </div>

        <div class="row toggles">
          <label class="toggle-label">
            <input type="checkbox" formControlName="active">
            <span>Visible</span>
          </label>
          <label class="toggle-label">
            <input type="checkbox" formControlName="featured">
            <span>Featured</span>
          </label>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancel" (click)="closeForm()">Cancel</button>
          <button type="submit" class="btn-submit" [disabled]="productForm.invalid">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>
